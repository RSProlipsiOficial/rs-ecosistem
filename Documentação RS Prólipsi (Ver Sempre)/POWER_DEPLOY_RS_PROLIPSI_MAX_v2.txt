POWER DEPLOY • RS Prólipsi (MAX) • End-to-End
Versão 2.0 • Atualizado em 18/11/2025
Guia oficial de deploy e operação do ecossistema RS Prólipsi (VPS Hostinger Ubuntu 24.04). Inclui: SSH/usuários, Node/NVM, PNPM, PM2, Docker, Nginx, Certbot, mapeamento de domínios, CI/CD, healthchecks e troubleshooting.

1) Domínios e Portas (mapa oficial • ambiente atual)
Referência direta aos containers do `docker-compose.core.yml` (variáveis em `infra/docker/.env.core`).

┌───────────────────────────────┬────────┬─────────────────────────┐
│ Domínio / Serviço             │ Porta  │ Container / Observação  │
├───────────────────────────────┼────────┼─────────────────────────┤
│ rsprolipsi.com.br             │ 3000   │ rs-site (Loja)          │
│ admin.rsprolipsi.com.br       │ 3001   │ rs-admin                │
│ escritorio.rsprolipsi.com.br  │ 3002   │ rs-consultor            │
│ marketplace.rsprolipsi.com.br │ 3003   │ rs-marketplace          │
│ wallet.rsprolipsi.com.br      │ 3004   │ rs-walletpay            │
│ logistica.rsprolipsi.com.br   │ 3005   │ rs-logistica            │
│ studio.rsprolipsi.com.br      │ 3006   │ rs-studio               │
│ docs.rsprolipsi.com.br        │ 3010   │ rs-docs                 │
│ logos.rsprolipsi.com.br       │ 3011   │ rs-template-game (games)│
│ ops.rsprolipsi.com.br         │ 3012   │ rs-ops-app              │
│ api.rsprolipsi.com.br         │ 4000   │ rs-api (back-end)       │
│ core.rsprolipsi.com.br        │ 4001   │ rs-core (serviço core)  │
│ config.rsprolipsi.com.br      │ 4002   │ rs-config               │
│ rotafacil.rsprolipsi.com.br   │ 3011*  │ apontar para rotas (ver │
│                               │        │ necessidade específica) │
└───────────────────────────────┴────────┴─────────────────────────┘

Observações:
• Caso mantenha domínios adicionais (n8n, Evolution/Bolt etc.), reutilize o snippet de Nginx e exponha as portas auxiliares (vide seção 10).
• Se for necessário preservar o roteamento antigo (ex.: rsprolipsi.com.br → 3004), basta ajustar os valores em `infra/docker/.env.core` para o novo alvo e refazer o deploy.
• Todos os serviços acima estão containerizados em Docker multi-stage (Node 20) com PNPM (`corepack enable`, `pnpm install --frozen-lockfile`, `pnpm build`/`pnpm start`). Qualquer alteração de dependência deve atualizar o `pnpm-lock.yaml` correspondente antes de rebuild.

2) Provisionamento do Servidor (root)
sudo -i
adduser deploy && usermod -aG sudo deploy
mkdir -p /home/deploy/.ssh && chmod 700 /home/deploy/.ssh
nano /home/deploy/.ssh/authorized_keys
chmod 600 /home/deploy/.ssh/authorized_keys && chown -R deploy:deploy /home/deploy/.ssh

# SSH
cp /etc/ssh/sshd_config /etc/ssh/sshd_config.bak
nano /etc/ssh/sshd_config
# Port 22
# PermitRootLogin no
# PasswordAuthentication no
# PubkeyAuthentication yes
systemctl restart ssh

# Básicos
apt-get update && apt-get upgrade -y
apt-get install -y curl git ufw fail2ban nginx python3-certbot-nginx

3) Stack PNPM + Docker (novo padrão)
- Node.js 20 + Corepack habilitado (PNPM default).
- Todos os apps possuem `pnpm-lock.yaml` e Dockerfile multi-stage (build stage executa `pnpm install --frozen-lockfile` / `pnpm build`; runtime stage roda `pnpm start` ou `serve -s dist`).
- `docker-compose.core.yml` usa o monorepo como contexto (`context: ../../`) e referencia os Dockerfiles em `apps/<serviço>/Dockerfile`.
- Para rebuild completo: `docker compose --env-file infra/docker/.env.core -f infra/docker/docker-compose.core.yml build --no-cache && docker compose ... up -d`.
- Alterou dependência? Atualize o `pnpm-lock.yaml` do app (`pnpm install`) antes do próximo deploy.

# Firewall
ufw allow OpenSSH
ufw allow 'Nginx Full'
ufw --force enable
systemctl enable --now fail2ban

3) Node.js (NVM) + PNPM + PM2
su - deploy
curl -fsSL https://raw.githubusercontent.com/nvm-sh/nvm/v0.39.7/install.sh | bash
source ~/.nvm/nvm.sh
nvm install 20.10.0 && nvm alias default 20.10.0
corepack enable && corepack prepare pnpm@latest --activate
npm i -g pm2

4) Estrutura de Pastas (atual)
Diretório de projetos: /home/deploy/dev
Repos: rs-admin, rs-consultor, rs-marketplace, rs-api, rs-studio, rs-walletpay, rs-logistica, rs-config, rs-site, rs-core, rs-docs, rs-rotafacil, rs-robo-kagi-binance, rs-template-game, rs-ops

5) .env • modelos
nano /home/deploy/dev/<repo>/.env
SUPABASE_URL="https://XXXXX.supabase.co"
SUPABASE_ANON_KEY="..."
SUPABASE_SERVICE_ROLE_KEY="..."
NODE_ENV=development
PORT=<porta_do_app>
APP_BASE_URL="https://<subdominio>"
SESSION_SECRET="troque-por-uma-chave-forte"
LOG_LEVEL=info

6) Nginx • snippet comum (proxy)
nano /etc/nginx/snippets/rs-common.conf
proxy_set_header Host $host;
proxy_set_header X-Real-IP $remote_addr;
proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
proxy_set_header X-Forwarded-Proto $scheme;
proxy_read_timeout 120s;

7) Gerador de server blocks (todos os domínios)
nano /root/gen-rs-nginx.sh
#!/usr/bin/env bash
set -euo pipefail
declare -A DOMPORT=(
  [rsprolipsi.com.br]=3004
  [admin.rsprolipsi.com.br]=3001
  [escritorio.rsprolipsi.com.br]=3002
  [marketplace.rsprolipsi.com.br]=3003
  [api.rsprolipsi.com.br]=4000
  [studio.rsprolipsi.com.br]=33006
  [wallet.rsprolipsi.com.br]=3005
  [logistica.rsprolipsi.com.br]=3007
  [config.rsprolipsi.com.br]=3008
  [core.rsprolipsi.com.br]=3009
  [docs.rsprolipsi.com.br]=3010
  [rotafacil.rsprolipsi.com.br]=3011
  [bot.rsprolipsi.com.br]=18080
  [game.rsprolipsi.com.br]=3013
  [ops.rsprolipsi.com.br]=3014
)
for domain in "${!DOMPORT[@]}"; do
  port="${DOMPORT[$domain]}"
  cat >/etc/nginx/sites-available/${domain}.conf <<EOF
server {
  listen 80;
  server_name ${domain};
  location / { proxy_pass http://127.0.0.1:${port};
    proxy_set_header Host $host;
    proxy_set_header X-Real-IP $remote_addr;
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    proxy_set_header X-Forwarded-Proto $scheme;
  }
}
EOF
  ln -sf /etc/nginx/sites-available/${domain}.conf /etc/nginx/sites-enabled/${domain}.conf
done
nginx -t && systemctl reload nginx
chmod +x /root/gen-rs-nginx.sh && /root/gen-rs-nginx.sh

8) SSL • emissão
apt-get update && apt-get install -y certbot python3-certbot-nginx
certbot --nginx -d rsprolipsi.com.br -d www.rsprolipsi.com.br
for d in admin.rsprolipsi.com.br escritorio.rsprolipsi.com.br marketplace.rsprolipsi.com.br api.rsprolipsi.com.br studio.rsprolipsi.com.br wallet.rsprolipsi.com.br logistica.rsprolipsi.com.br config.rsprolipsi.com.br core.rsprolipsi.com.br docs.rsprolipsi.com.br rotafacil.rsprolipsi.com.br bot.rsprolipsi.com.br game.rsprolipsi.com.br ops.rsprolipsi.com.br; do certbot --nginx -d "$d"; done
nginx -t && systemctl reload nginx

9) PM2 • Orquestração (deploy atual)
su - deploy
Ecosystem: /home/deploy/ecosystem.config.js
Apps:
- rs-api → pnpm start (PORT=4000)
- rs-admin → pnpm dev --port 3001
- rs-consultor → pnpm dev --port 3002
- rs-marketplace → pnpm dev --port 3003
- rs-controle Drop → pnpm dev --port 3103
- rs-CDS → pnpm dev --port 3203
- rs-site → pnpm dev --port 3004
- rs-walletpay → pnpm dev --port 3005
- rs-studio → pnpm dev --port 3006
- rs-logistica → pnpm dev --port 3007
- rs-config → pnpm dev --port 3008
- rs-core → pnpm dev --port 3009
- rs-docs → pnpm dev --port 3010
- rs-rotafacil → pnpm dev --port 3011
- rs-robo-kagi-binance → pnpm dev --port 3012
- rs-template-game → pnpm dev --port 3013
- rs-ops → pnpm dev --port 3014
Comandos:
cd /home/deploy && pm2 start ecosystem.config.js && pm2 save
pm2 startup systemd -u deploy --hp /home/deploy

10) Docker • Serviços auxiliares
Evolution API:
/home/deploy/dev/docker-compose.evolution.yml
services:
  rs-whatsapp:
    image: atendai/evolution-api:latest
    ports:
      - "18080:8080"
    env_file:
      - /home/deploy/dev/evolution/.env
    environment:
      - DATABASE_PROVIDER=filesystem
    volumes:
      - evolution_store:/evolution/store
      - evolution_instances:/evolution/instances
n8n:
/home/deploy/dev/docker-compose.n8n.yml (porta 5680, volume /home/deploy/data/n8n owner 1000:1000)
Bolt (Studio):
/home/deploy/dev/docker-compose.rs-studio.yml (porta 33006)

11) CI/CD • GitHub → VPS
Arquivo por repo: .github/workflows/deploy.yml
name: Deploy to VPS
on:
  push:
    branches: [ main ]
jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Deploy Over SSH
        uses: appleboy/ssh-action@v0.1.14
        with:
          host: ${{ secrets.SSH_HOST }}
          username: ${{ secrets.SSH_USER }}
          key: ${{ secrets.SSH_KEY }}
          known_hosts: ${{ secrets.SSH_KNOWN_HOSTS }}
          script: |
            set -e
            cd /home/deploy/dev/<repo>
            git pull
            pnpm i --prefer-frozen-lockfile || pnpm i
            if [ -f package.json ] && jq -e '.scripts.build' package.json >/dev/null 2>&1; then pnpm build; fi
            pm2 restart <process-name> --update-env
Secrets (org GitHub): SSH_HOST, SSH_USER, SSH_KEY, SSH_KNOWN_HOSTS

12) Healthchecks e Monitoramento
GET /health → { ok: true }
GET /version → { commit, build }
pm2 ls; pm2 logs --lines 200; pm2 monit
journalctl -u nginx -f

13) Troubleshooting
• 502 Bad Gateway: app fora do ar ou porta errada → pm2 ls; pm2 logs
• SSL falhou: checar DNS A/AAAA e liberar 80/443
• Sem cadeado: mixed content em SPA → usar URLs https
• CORS: habilitar origin true na API e revisar APP_BASE_URL
• Build: Node 20.10, memória/swap, permissões

14) Índice (nano)
• /etc/nginx/snippets/rs-common.conf
• /root/gen-rs-nginx.sh
• /etc/nginx/sites-available/*.conf
• /home/deploy/ecosystem.config.js
• /home/deploy/dev/<repo>/.env
• /home/deploy/dev/docker-compose.evolution.yml
• /home/deploy/dev/docker-compose.n8n.yml
• /home/deploy/dev/docker-compose.rs-studio.yml

===================================
Email admin 
rsprolipsioficial@gmail.com
senha para o admin Yannis784512@
===================================
Api Key OpenHunter  RS-IA 
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
===================================
Checklist Geral • VPS RS Prólipsi
Ubuntu 24.04 LTS • Hostname: srv990916.hstgr.cloud • IP: 72.60.144.245 • Acesso root: ssh root@72.60.144.245

FIM • Documento atualizado conforme estado atual da VPS (ports, engines, diretórios e orquestração).