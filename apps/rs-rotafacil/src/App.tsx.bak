import { PWARegister } from "@/components/pwa/PWARegister";
import { Toaster } from "@/components/ui/toaster";
import { Toaster as Sonner } from "@/components/ui/sonner";
import { TooltipProvider } from "@/components/ui/tooltip";
import { QueryClient, QueryClientProvider } from "@tanstack/react-query";
import { BrowserRouter, Routes, Route, Navigate } from "react-router-dom";
import PublicIndicacao from "./pages/indicacao/PublicIndicacao";
import ProtectedRoute from "./components/auth/ProtectedRoute";
import { RoleBasedRoute } from "./components/RoleBasedRoute";
import Index from "./pages/Index";
import AlunosIndex from "./pages/alunos/Index";
import PublicCadastro from "./pages/alunos/PublicCadastro";
import PublicUpdate from "./pages/alunos/PublicUpdate";
import GerenciarVan from "./pages/alunos/GerenciarVan";
import FinanceiroIndex from "./pages/financeiro/Index";
import MensalidadesIndex from "./pages/mensalidades/Index";
import MotoristaIndex from "./pages/motorista/Index";
import MonitoraIndex from "./pages/monitora/Index";
import WhatsAppIndex from "./pages/whatsapp/Index";
import AdminWhatsAppIndex from "./pages/admin/WhatsAppIndex";
import AdminAutomacoesIndex from "./pages/admin/AutomacoesIndex";
import EducacaoFinanceiraIndex from "./pages/educacao-financeira/Index";
import TreinamentosIndex from "./pages/treinamentos/Index";
import TreinamentoDetalhes from "./pages/treinamentos/TreinamentoDetalhes";
import UpgradeIndex from "./pages/upgrade/Index";
import SuporteIndex from "./pages/suporte/Index";
import PerfilIndex from "./pages/perfil/Index";
import AuthIndex from "./pages/auth/Index";
import ResetPassword from "./pages/auth/ResetPassword";
import LandingIndex from "./pages/landing/Index";

import SiteIndex from "./pages/site/Index";
import IndicacaoIndex from "./pages/indicacao/Index";
import IAIndex from "./pages/ia/Index";
import IAConfiguracao from "./pages/ia/Configuracao";
import ImportarIndex from "./pages/importar/Index";
import AdminIndex from "./pages/admin/Index";
import AdminAppsIndex from "./pages/admin/apps/Index";
import AdminFinanceiroIndex from "./pages/admin/financeiro/Index";
import AdminAuditoriaIndex from "./pages/admin/auditoria/Index";
import AdminTutoriaisIndex from "./pages/admin/tutoriais/Index";
import AdminSuporteIndex from "./pages/admin/suporte/Index";
import AdminSiteIndex from "./pages/admin/site/Index";
import AdminPacksIndex from "./pages/admin/packs/Index";
import AdminCreditosIAIndex from "./pages/admin/creditos-ia/Index";
import AdminTreinamentosIndex from "./pages/admin/treinamentos/Index";
import AdminTreinamentoAulas from "./pages/admin/treinamentos/Aulas";
import AdminUsuariosIndex from "./pages/admin/usuarios/Index";
import AdminVisualizarUsuario from "./pages/admin/usuarios/VisualizarUsuario";
import AdminLoginIndex from "./pages/admin/login/Index";
import AdminConfiguracoesIndex from "./pages/admin/configuracoes/Index";
import AdminPixelsIndex from "./pages/admin/pixels/Index";
import ResponsavelIndex from "./pages/responsavel/Index";
import ResponsavelLogin from "./pages/responsavel/Login";
import MeusFilhos from "./pages/responsavel/MeusFilhos";
import ResponsavelFinanceiro from "./pages/responsavel/Financeiro";
import ResponsavelPresencas from "./pages/responsavel/Presencas";
import ResponsavelComunicados from "./pages/responsavel/Comunicados";
import ResponsavelSuporte from "./pages/responsavel/Suporte";
import EquipeIndex from "./pages/equipe/Index";
import ConsultorCadastroIndex from "./pages/consultor/cadastro/Index";
import DemonstracaoIndex from "./pages/demonstracao/Index";
import NovoLancamento from "./pages/financeiro/NovoLancamento";
import NotFound from "./pages/NotFound";

import TermsOfUse from "./pages/legal/TermsOfUse";
import PrivacyPolicy from "./pages/legal/PrivacyPolicy";
import CookieConsent from "./components/legal/CookieConsent";

import { BrandingManager } from "./components/layout/branding-manager";
import { PixelManager } from "./components/tracking/PixelManager";

const queryClient = new QueryClient();

const App = () => (
  <QueryClientProvider client={queryClient}>
    <BrandingManager />
    <TooltipProvider>
      <Toaster />
      <Sonner />
      <BrowserRouter future={{ v7_startTransition: true, v7_relativeSplatPath: true }}>
        <PWARegister />
        <CookieConsent />
        <PixelManager />
        <Routes>
          {/* Public Routes */}
          <Route path="/familia/login" element={<ResponsavelLogin />} />
          <Route path="/familia" element={<Navigate to="/familia/login" replace />} />
          <Route path="/" element={<LandingIndex />} />
          <Route path="/auth" element={<AuthIndex />} />
          <Route path="/auth/reset-password" element={<ResetPassword />} />
          <Route path="/consultor/login" element={<AuthIndex restrictedTo="consultor" />} />
          <Route path="/landing" element={<LandingIndex />} />
          <Route path="/aluno/cadastro/:identifier" element={<PublicCadastro />} />
          <Route path="/aluno/atualizar/:token" element={<PublicUpdate />} />
          <Route path="/indicacao/:codigo" element={<PublicIndicacao />} />
          <Route path="/consultor/cadastro" element={<ConsultorCadastroIndex />} />
          <Route path="/demonstracao" element={<DemonstracaoIndex />} />
          <Route path="/termos-de-uso" element={<TermsOfUse />} />
          <Route path="/politica-privacidade" element={<PrivacyPolicy />} />
          <Route path="/admin/login" element={<AdminLoginIndex />} />

          {/* Protected Owner/Consultor Routes (Escritório do Dono / Painel Principal) */}
          <Route element={<ProtectedRoute />}>
            <Route path="/painel" element={<Index />} />
            <Route path="/app" element={<Navigate to="/painel" replace />} />
            <Route path="/alunos" element={<AlunosIndex />} />
            <Route path="/alunos/gerenciar-van" element={<GerenciarVan />} />
            <Route path="/financeiro" element={<FinanceiroIndex />} />
            <Route path="/financeiro/novo-lancamento" element={<NovoLancamento />} />
            <Route path="/mensalidades" element={<MensalidadesIndex />} />
            <Route path="/whatsapp" element={<WhatsAppIndex />} />
            <Route path="/educacao-financeira" element={<EducacaoFinanceiraIndex />} />
            <Route path="/treinamentos" element={<TreinamentosIndex />} />
            <Route path="/treinamentos/:moduloId" element={<TreinamentoDetalhes />} />
            <Route path="/upgrade" element={<UpgradeIndex />} />
            <Route path="/suporte" element={<SuporteIndex />} />
            <Route path="/perfil" element={<PerfilIndex />} />
            <Route path="/site" element={<SiteIndex />} />
            <Route path="/ia" element={<IAIndex />} />
            <Route path="/ia/configuracao" element={<IAConfiguracao />} />
            <Route path="/importar" element={<ImportarIndex />} />
            <Route path="/equipe" element={<EquipeIndex />} />
            <Route path="/indicacao" element={<IndicacaoIndex />} />
            <Route path="/consultor/indicacao" element={<IndicacaoIndex />} />
          </Route>

          {/* Protected Motorista Routes */}
          <Route element={<ProtectedRoute />}>
            <Route path="/motorista" element={<MotoristaIndex />} />
          </Route>

          {/* Protected Monitora Routes */}
          <Route element={<ProtectedRoute />}>
            <Route path="/monitora" element={<MonitoraIndex />} />
          </Route>

          {/* Protected Admin Routes */}
          <Route element={<ProtectedRoute onlyAdmin />}>
            <Route path="/admin" element={<AdminIndex />} />
            <Route path="/admin/apps" element={<AdminAppsIndex />} />
            <Route path="/admin/financeiro" element={<AdminFinanceiroIndex />} />
            <Route path="/admin/auditoria" element={<AdminAuditoriaIndex />} />
            <Route path="/admin/suporte" element={<AdminSuporteIndex />} />
            <Route path="/admin/site" element={<AdminSiteIndex />} />
            <Route path="/admin/treinamentos" element={<AdminTreinamentosIndex />} />
            <Route path="/admin/treinamentos/:moduloId/aulas" element={<AdminTreinamentoAulas />} />
            <Route path="/admin/packs" element={<AdminPacksIndex />} />
            <Route path="/admin/creditos-ia" element={<AdminCreditosIAIndex />} />
            <Route path="/admin/usuarios" element={<AdminUsuariosIndex />} />
            <Route path="/admin/usuarios/:id/visualizar" element={<AdminVisualizarUsuario />} />
            <Route path="/admin/configuracoes" element={<AdminConfiguracoesIndex />} />
            <Route path="/admin/pixels" element={<AdminPixelsIndex />} />
            <Route path="/admin/whatsapp" element={<AdminWhatsAppIndex />} />
            {/* Redirecionar antigas rotas de automação para o novo Multi-Agente */}
            <Route path="/admin/automacoes" element={<Navigate to="/admin/whatsapp" replace />} />
            <Route path="/admin/automacao-whatsapp" element={<Navigate to="/admin/whatsapp" replace />} />
          </Route>


          {/* Protected Responsavel Routes */}
          <Route path="/responsavel" element={<ProtectedRoute />}>
            <Route index element={<ResponsavelIndex />} />
            <Route path="filhos" element={<MeusFilhos />} />
            <Route path="financeiro" element={<ResponsavelFinanceiro />} />
            <Route path="presencas" element={<ResponsavelPresencas />} />
            <Route path="comunicados" element={<ResponsavelComunicados />} />
            <Route path="suporte" element={<ResponsavelSuporte />} />
          </Route>

          {/* ADD ALL CUSTOM ROUTES ABOVE THE CATCH-ALL "*" ROUTE */}
          <Route path="*" element={<NotFound />} />
        </Routes>
      </BrowserRouter>
    </TooltipProvider>
  </QueryClientProvider>
);

export default App;