import { useState, useEffect, useRef } from "react";
import { Card, CardContent, CardHeader, CardTitle } from "@/components/ui/card";
import { Button } from "@/components/ui/button";
import { Input } from "@/components/ui/input";
import { Label } from "@/components/ui/label";
import { Select, SelectContent, SelectItem, SelectTrigger, SelectValue } from "@/components/ui/select";
import { Badge } from "@/components/ui/badge";
import { Textarea } from "@/components/ui/textarea";
import { Users, Edit3, Save, X, Key, Mail, Phone, User, Plus, UserPlus, ChevronRight, ChevronLeft, Folder, Home, RefreshCw, Search, BadgeCheck, Package, Loader2, CreditCard, Shield, ArrowLeft, AlertTriangle, AlertCircle, Bus, UserCheck, Target } from "lucide-react";
import { supabase } from "@/integrations/supabase/client";
import { useToast } from "@/hooks/use-toast";
import { AdminLayout } from "@/components/layout/admin-layout";
import { useNavigate, useLocation } from "react-router-dom";
import { z } from "zod";

interface Usuario {
  id: string;
  nome: string;
  email: string;
  telefone?: string;
  status: string;
  tipo_usuario: string;
  created_at: string;
  updated_at: string;
  ultimo_login?: string;
  salario_base?: number;
  pix_key?: string;
  pix_type?: string;
  plan_id?: string;
  van_id?: string;
  cpf?: string;
  motoristas?: number;
  monitoras?: number;
  alunos?: number;
  indicados?: number;
  endereco?: {
    cep?: string;
    rua?: string;
    numero?: string;
    bairro?: string;
    cidade?: string;
    estado?: string;
    complemento?: string;
  };
}

interface TeamUsage {
  motoristas: number;
  monitoras: number;
  alunos: number;
  indicados?: number;
}

export default function AdminUsuariosIndex() {
  const [usuarios, setUsuarios] = useState<Usuario[]>([]);
  const [teamUsage, setTeamUsage] = useState<Record<string, TeamUsage>>({});
  const [loading, setLoading] = useState(true);
  const [saving, setSaving] = useState(false);
  const [changingPassword, setChangingPassword] = useState(false);
  const [editingUser, setEditingUser] = useState<Usuario | null>(null);
  const [showPasswordForm, setShowPasswordForm] = useState<string | null>(null);
  const [breadcrumbs, setBreadcrumbs] = useState<{ id: string | null, nome: string }[]>([{ id: null, nome: "Geral" }]);
  const [currentParentId, setCurrentParentId] = useState<string | null>(null);
  const [filterMode, setFilterMode] = useState<'rotafacil' | 'all'>('rotafacil');
  const [searchTerm, setSearchTerm] = useState("");
  const [userCounts, setUserCounts] = useState({ total: 0, rotafacil: 0 });
  const [duplicates, setDuplicates] = useState<any[]>([]);
  const [plans, setPlans] = useState<{ id: string, name: string }[]>([]);
  const { toast } = useToast();
  const navigate = useNavigate();
  const location = useLocation();
  const [typeFilter, setTypeFilter] = useState<string | null>(null);
  const [error, setError] = useState<string | null>(null);

  const [formData, setFormData] = useState({
    nome: "",
    email: "",
    telefone: "",
    status: "ativo",
    tipo_usuario: "usuario",
    plan_id: "",
    van_id: "",
    pix_type: "",
    pix_key: "",
    salario_base: 0,
    senha: "",
    cpf: "",
    cep: "",
    rua: "",
    numero: "",
    bairro: "",
    cidade: "",
    estado: "",
    complemento: ""
  });

  const [passwordData, setPasswordData] = useState({
    newPassword: "",
    confirmPassword: ""
  });

  const [showNewUserForm, setShowNewUserForm] = useState(false);
  const [newUserData, setNewUserData] = useState({
    nome: "",
    email: "",
    password: "",
    confirmPassword: "",
    telefone: "",
    status: "ativo",
    tipo_usuario: "usuario",
    cpf: "",
    cep: "",
    rua: "",
    numero: "",
    bairro: "",
    cidade: "",
    estado: "",
    complemento: "",
    salario_base: 0,
    pix_key: "",
    pix_type: "",
    van_id: "",
    plan_id: ""
  });

  const newUserSchema = z.object({
    nome: z.string().min(2, "Nome deve ter pelo menos 2 caracteres"),
    email: z.string().email("Email inv√°lido"),
    password: z.string().min(6, "Senha deve ter pelo menos 6 caracteres"),
    confirmPassword: z.string(),
  }).refine((data) => data.password === data.confirmPassword, {
    message: "Senhas n√£o coincidem",
    path: ["confirmPassword"]
  });

  const lastLoadedParamsRef = useRef("");

  useEffect(() => {
    // Ler par√¢metros da URL
    const params = new URLSearchParams(location.search);
    const urlParentId = params.get('parentId');
    const urlFilterType = params.get('filterType');

    // Sincronizar estados com a URL apenas se houver mudan√ßa REAL (evita renders infinitos)
    const searchKey = `${urlParentId || 'root'}-${urlFilterType || 'none'}-${filterMode}`;
    if (lastLoadedParamsRef.current === searchKey) return;
    lastLoadedParamsRef.current = searchKey;

    if (urlParentId !== currentParentId || urlFilterType !== typeFilter) {
      setCurrentParentId(urlParentId);
      setTypeFilter(urlFilterType);

      // Sincronizar breadcrumbs
      setBreadcrumbs(prev => {
        if (urlParentId === null) {
          if (urlFilterType) {
            const typeLabel = urlFilterType === 'motorista' ? 'Motoristas' :
              urlFilterType === 'monitora' ? 'Monitoras' :
                urlFilterType === 'aluno' ? 'Alunos' :
                  urlFilterType === 'indicado' ? 'Indicados' : 'Filtrado';
            return [{ id: null, nome: "Geral" }, { id: 'filter', nome: typeLabel }];
          }
          return [{ id: null, nome: "Geral" }];
        }

        // Se estamos navegando em pastas
        const parentIndex = prev.findIndex(b => b.id === urlParentId);
        let newPath = [];

        if (parentIndex !== -1) {
          // J√° est√° no caminho, volta at√© ali
          newPath = prev.slice(0, parentIndex + 1);
        } else {
          // Novo n√≠vel (remove filtro anterior se houver)
          const base = prev.filter(b => b.id !== 'filter');
          const targetUser = usuarios.find(u => u.id === urlParentId);
          newPath = [...base, { id: urlParentId, nome: targetUser?.nome || 'Equipe' }];
        }

        // Adiciona label de filtro se houver
        if (urlFilterType) {
          const typeLabel = urlFilterType === 'motorista' ? 'Motoristas' :
            urlFilterType === 'monitora' ? 'Monitoras' :
              urlFilterType === 'aluno' ? 'Alunos' :
                urlFilterType === 'indicado' ? 'Indicados' : 'Filtrado';
          return [...newPath.filter(b => b.id !== 'filter'), { id: 'filter', nome: typeLabel }];
        }

        return newPath.filter(b => b.id !== 'filter');
      });
    }

    // Carregar apenas uma vez por mudan√ßa de par√¢metro de busca ou modo
    loadUsuarios(urlParentId, urlFilterType);

    // Carregar planos apenas uma vez na montagem
  }, [location.search, filterMode]);

  // Efeito isolado para planos
  useEffect(() => {
    loadPlans();
  }, []);

  const loadPlans = async () => {
    const { data } = await supabase.from('subscription_plans').select('id, name');
    if (data) setPlans(data);
  };

  const loadUsuarios = async (parentIdArg?: string | null, filterTypeArg?: string | null) => {
    try {
      setLoading(true);
      setError(null);

      // Usar argumentos ou estado atual
      const pId = (parentIdArg !== undefined && parentIdArg !== null && typeof parentIdArg !== 'object') ? parentIdArg : currentParentId;
      const fType = (filterTypeArg !== undefined && filterTypeArg !== null && typeof filterTypeArg !== 'object') ? filterTypeArg : typeFilter;

      // 1. Carregar Usos da Equipe e Usu√°rios em paralelo
      const [usageResult, rpcResult] = await Promise.all([
        (supabase as any).rpc('get_admin_user_team_usage'),
        (supabase as any).rpc('get_admin_users_list', { p_parent_id: pId || null })
      ]);

      if (usageResult.error) console.error('Usage Error:', usageResult.error);
      if (rpcResult.error) throw rpcResult.error;

      const usageMap = usageResult.data || {};
      setTeamUsage(usageMap);

      // A RPC retorna array diretamente (√© o resultado de get_admin_users_v2)
      const allFetchedUsersRaw = Array.isArray(rpcResult.data) ? rpcResult.data : [];
      const allFetchedUsers = allFetchedUsersRaw.map((u: any) => {
        const meta = u.user_metadata || {};
        const usage = usageMap[u.id] || { motoristas: 0, monitoras: 0, alunos: 0, indicados: 0, plan_id: null };

        // Mapeamento consistente de nomes e telefones
        const nome = u.nome || meta.nome || meta.name || meta.full_name || meta.nome_completo || meta.displayName || 'Sem Nome';
        const telefone = u.telefone || meta.telefone || meta.phone || meta.whatsapp || '';

        // Mapeamento consistente de tipos (Normalizando roles)
        const metaType = (meta.tipo_usuario || meta.user_type || meta.role || '').toLowerCase();
        const dbType = (u.tipo_usuario || u.tipo || '').toLowerCase();

        // Priorizar tipos que indicam Dono/Master
        let tipo = 'usuario';
        if (['owner', 'master', 'admin', 'superadmin'].includes(metaType)) tipo = metaType;
        else if (['owner', 'master', 'admin', 'superadmin'].includes(dbType)) tipo = dbType;
        else tipo = dbType || metaType || 'usuario';

        // Normaliza√ß√£o final para exibi√ß√£o
        if (tipo === 'superadmin') tipo = 'admin';
        if (tipo === 'proprietario' || tipo === 'dono') tipo = 'owner';
        if (tipo === 'mestre') tipo = 'master';

        // Detec√ß√£o robusta de plan_id e kit para separa√ß√£o de abas
        const planId = u.plan_id || meta.plan_id || usage.plan_id || null;
        const hasKit = !!meta.kit || !!meta.plano || !!meta.plan || !!planId;

        return {
          id: u.id,
          email: u.email,
          nome,
          telefone,
          status: u.status || meta.status || 'ativo',
          tipo_usuario: tipo,
          van_id: u.van_id || meta.van_id || null,
          salario_base: u.salario_base || Number(meta.salario || meta.salario_base) || 0,
          cpf: u.cpf || meta.cpf || '',
          sponsor_id: u.sponsor_id || meta.sponsor_id || meta.boss_id || meta.created_by || null,
          plan_id: planId,
          has_kit: hasKit, // Flag crucial
          created_at: u.created_at,
          updated_at: u.updated_at,
          ultimo_login: u.ultimo_login || u.last_sign_in_at,
          // Contagens herdadas do usageMap para garantir exibi√ß√£o em todos os cards
          motoristas: usage.motoristas || 0,
          monitoras: usage.monitoras || 0,
          alunos: usage.alunos || 0,
          indicados: usage.indicados || 0,
          endereco: u.endereco || meta.endereco || {
            cep: meta.cep || '',
            rua: meta.rua || '',
            numero: meta.numero || '',
            bairro: meta.bairro || '',
            cidade: meta.cidade || '',
            estado: meta.estado || '',
            complemento: meta.complemento || ''
          }
        };
      });
      // RPC n√£o retorna debug info, removendo refer√™ncia obsoleta

      // 2. Garantir que o usu√°rio logado apare√ßa
      const { data: { user: currentUser } } = await supabase.auth.getUser();
      if (currentUser) {
        const isSelfInList = allFetchedUsers.some((u: any) => u.id === currentUser.id);
        if (!isSelfInList) {
          const selfMeta = currentUser.user_metadata || {};
          // DO NOT default to master if we don't know the role
          const finalRole = selfMeta.tipo_usuario || selfMeta.user_type || 'usuario';
          allFetchedUsers.unshift({
            id: currentUser.id,
            email: currentUser.email,
            nome: selfMeta.name || selfMeta.nome || selfMeta.full_name || 'Admin Principal',
            tipo_usuario: finalRole,
            user_metadata: selfMeta,
            created_at: currentUser.created_at,
            sponsor_id: null,
            boss_id: null,
            // Injetando stats manualmente para n√£o zerar card do admin se n√£o vier api
            stats: usageMap[currentUser.id] || { motoristas: 0, monitoras: 0, alunos: 0, indicados: 0 },
            app: selfMeta.app || 'rotafacil'
          });
        }
      }

      // 3. SEPARA√á√ÉO RIGOROSA: ROTA F√ÅCIL vs AGUARDANDO KIT
      // Regra: "Donos/Master ou quem comprou Kit -> Rota F√°cil. O resto (leads) -> Aguardando Kit."

      const activeCompanies = allFetchedUsers.filter((u: any) => {
        const uTipo = u.tipo_usuario?.toLowerCase();
        const isOwnerOrMaster = ['owner', 'master', 'admin'].includes(uTipo);
        const hasProduct = u.has_kit || ['motorista', 'monitora'].includes(uTipo) || (u.nome?.toLowerCase().includes('rota f√°cil'));

        // Donos sempre na aba principal (Rota F√°cil)
        const shouldBeInMainList = isOwnerOrMaster || hasProduct;

        // Se for admin mas n√£o tiver produto, s√≥ mostra se for o pr√≥prio Roberto
        if (uTipo === 'admin' && !hasProduct && !u.nome?.toLowerCase().includes('pr√≥lipsi')) return false;

        return shouldBeInMainList;
      });

      // 4. AGUARDANDO KIT: Leads e indica√ß√µes sem nenhum produto
      const pendingCompanies = allFetchedUsers.filter((u: any) => {
        const isActive = activeCompanies.some(a => a.id === u.id);
        if (isActive) return false;

        const uTipo = u.tipo_usuario?.toLowerCase();
        if (uTipo === 'admin') return false;

        return true;
      });



      // 5. Definir exibi√ß√£o final com Filtragem Defensiva (Rigor DevOps)
      let finalDisplayUsers = allFetchedUsers;

      if (fType) {
        // Filtragem rigorosa por tipo no frontend (Segunda linha de defesa caso o backend falhe)
        finalDisplayUsers = allFetchedUsers.filter((u: any) => {
          const uTipo = (u.tipo_usuario || u.tipo || '').toLowerCase();

          // Mapeamento rigoroso para filtros espec√≠ficos
          if (fType === 'aluno') return uTipo === 'aluno';
          if (fType === 'indicado') return uTipo === 'indicado' || uTipo === 'owner';
          if (fType === 'motorista') return uTipo === 'motorista';
          if (fType === 'monitora') return uTipo === 'monitora';
          if (fType === 'dono' || fType === 'master') {
            return ['master', 'owner', 'admin'].includes(uTipo);
          }

          return uTipo === fType.toLowerCase();
        });
      } else if (pId) {
        // Se navegando em equipe, mostra todos daquela equipe vinculada
        finalDisplayUsers = allFetchedUsers;
      } else if (filterMode === 'rotafacil') {
        finalDisplayUsers = activeCompanies;
      } else if (filterMode === 'all') {
        finalDisplayUsers = pendingCompanies;
      } else {
        finalDisplayUsers = allFetchedUsers.filter((u: any) => {
          if (pId === null) return !u.sponsor_id || u.sponsor_id === null;
          return u.sponsor_id === pId;
        });
      }

      setUserCounts({
        total: pendingCompanies.length,
        rotafacil: activeCompanies.length
      });

      // 6. Processar Duplicatas (Global)
      const cpfMap = new Map();
      const emailMap = new Map();
      const dups: any[] = [];
      allFetchedUsers.forEach((u: any) => {
        const cpf = u.cpf || u.user_metadata?.cpf;
        const emailLower = u.email?.toLowerCase();
        if (cpf && cpfMap.has(cpf)) dups.push(u);
        else if (cpf) cpfMap.set(cpf, u);
        if (emailLower && emailMap.has(emailLower)) dups.push(u);
        else if (emailLower) emailMap.set(emailLower, u);
      });
      setDuplicates(dups);

      setUsuarios(finalDisplayUsers);

      // Atualizar breadcrumb se necess√°rio
      if (pId) {
        const currentUserData = allFetchedUsers.find((u: any) => u.id === pId);
        if (currentUserData) {
          setBreadcrumbs(prev =>
            prev.map(b => b.id === pId ? { ...b, nome: currentUserData.nome } : b)
          );
        }
      }
    } catch (err: any) {
      console.error('Erro fatal loadUsuarios:', err);
      setError(err.message || 'Erro ao carregar lista de usu√°rios');
      toast({
        title: 'Erro de Carregamento',
        description: err.message || 'N√£o foi poss√≠vel carregar os usu√°rios.',
        variant: 'destructive',
      });
    } finally {
      setLoading(false);
    }
  };

  const handleResendConfirmationForUser = async (email: string) => {
    try {
      setLoading(true);
      const { data, error } = await supabase.functions.invoke('admin-users-v3', {
        method: 'POST',
        body: {
          email,
          action: 'resend-confirmation'
        }
      });

      if (error) throw error;

      toast({
        title: "Sucesso!",
        description: "E-mail de confirma√ß√£o reenviado para o colaborador.",
      });
    } catch (error: any) {
      console.error('Erro ao reenviar confirma√ß√£o:', error);
      toast({
        title: "Erro",
        description: error.message || "Erro ao reenviar confirma√ß√£o.",
        variant: "destructive",
      });
    } finally {
      setLoading(false);
    }
  };

  const handleSave = async () => {
    if (!editingUser) return;

    setSaving(true);
    try {
      // Chama a edge function para atualizar todos os dados (incluindo e-mail e CPF)
      const { data, error: fnError } = await supabase.functions.invoke('admin-users-v3', {
        method: 'PUT',
        body: {
          userId: editingUser.id,
          nome: formData.nome,
          email: formData.email,
          telefone: formData.telefone,
          cpf: formData.cpf,
          tipo_usuario: formData.tipo_usuario,
          status: formData.status,
          salario: formData.salario_base,
          plan_id: formData.plan_id || null,
          van_id: formData.van_id || null,
          pix_key: formData.pix_key || null,
          pix_type: formData.pix_type || null,
          app: 'rotafacil',
          endereco: {
            cep: formData.cep,
            rua: formData.rua,
            numero: formData.numero,
            bairro: formData.bairro,
            cidade: formData.cidade,
            estado: formData.estado,
            complemento: formData.complemento
          }
        }
      });

      if (fnError) throw fnError;

      toast({
        title: "Sucesso",
        description: "Usu√°rio atualizado com sucesso!",
      });

      setEditingUser(null);
      loadUsuarios(); // Reload to get updated stats and metadata
    } catch (error: any) {
      console.error("Erro ao salvar:", error);
      toast({
        title: "Erro ao salvar",
        description: error.message || "Tente novamente mais tarde.",
        variant: "destructive"
      });
    } finally {
      setSaving(false);
    }
  };

  const handleChangePassword = async (userId: string) => {
    if (passwordData.newPassword !== passwordData.confirmPassword) {
      toast({
        title: "Erro",
        description: "As senhas n√£o coincidem.",
        variant: "destructive",
      });
      return;
    }

    if (passwordData.newPassword.length < 6) {
      toast({
        title: "Erro",
        description: "A senha deve ter pelo menos 6 caracteres.",
        variant: "destructive",
      });
      return;
    }

    setChangingPassword(true);
    try {
      // Here you would implement the password change via Supabase Admin API
      // For example:
      const { data, error } = await supabase.functions.invoke('admin-users-v3', {
        method: 'PUT',
        body: {
          userId: userId,
          password: passwordData.newPassword,
        },
      });

      if (error) throw error;

      toast({
        title: "Sucesso",
        description: "Senha alterada com sucesso!",
      });

      setShowPasswordForm(null);
      setPasswordData({ newPassword: "", confirmPassword: "" });
    } catch (error: any) {
      console.error('Erro ao alterar senha:', error);
      toast({
        title: "Erro",
        description: error.message || "N√£o foi poss√≠vel alterar a senha.",
        variant: "destructive",
      });
    } finally {
      setChangingPassword(false);
    }
  };

  const handleEdit = (usuario: Usuario) => {
    setEditingUser(usuario);
    setFormData({
      nome: usuario.nome,
      email: usuario.email,
      telefone: usuario.telefone || "",
      status: usuario.status,
      tipo_usuario: usuario.tipo_usuario,
      plan_id: usuario.plan_id || "",
      van_id: usuario.van_id || "",
      senha: "",
      salario_base: usuario.salario_base || 0,
      pix_key: usuario.pix_key || "",
      pix_type: usuario.pix_type || "",
      cpf: usuario.cpf || "",
      cep: usuario.endereco?.cep || "",
      rua: usuario.endereco?.rua || "",
      numero: usuario.endereco?.numero || "",
      bairro: usuario.endereco?.bairro || "",
      cidade: usuario.endereco?.cidade || "",
      estado: usuario.endereco?.estado || "",
      complemento: usuario.endereco?.complemento || ""
    });
  };

  const handleRegisterPayment = async (userId: string) => {
    // Implementa√ß√£o simplificada de registro de pagamento via RPC
    const valor = prompt("Valor do pagamento:");
    if (!valor) return;

    const data = prompt("Data do pagamento (AAAA-MM-DD):", new Date().toISOString().split('T')[0]);
    if (!data) return;

    try {
      setSaving(true);
      const { error } = await (supabase as any)
        .from('pagamentos_equipe')
        .insert({
          user_id: userId,
          valor: parseFloat(valor),
          mes: new Date(data).getMonth() + 1,
          ano: new Date(data).getFullYear(),
          data_pagamento: data,
          status: 'pago'
        });

      if (error) throw error;

      toast({
        title: "Sucesso",
        description: "Pagamento registrado com sucesso!",
      });
    } catch (error: any) {
      toast({
        title: "Erro",
        description: error.message,
        variant: "destructive"
      });
    } finally {
      setSaving(false);
    }
  };

  const resetForm = () => {
    setFormData({
      nome: "",
      email: "",
      telefone: "",
      status: "ativo",
      tipo_usuario: "usuario",
      plan_id: "",
      van_id: "",
      senha: "",
      salario_base: 0,
      pix_key: "",
      pix_type: "",
      cpf: "",
      cep: "",
      rua: "",
      numero: "",
      bairro: "",
      cidade: "",
      estado: "",
      complemento: ""
    });
    setEditingUser(null);
    setShowPasswordForm(null);
  };

  const resetNewUserForm = () => {
    setNewUserData({
      nome: "",
      email: "",
      password: "",
      confirmPassword: "",
      telefone: "",
      status: "ativo",
      tipo_usuario: "usuario",
      cpf: "",
      cep: "",
      rua: "",
      numero: "",
      bairro: "",
      cidade: "",
      estado: "",
      complemento: "",
      salario_base: 0,
      pix_key: "",
      pix_type: "",
      van_id: "",
      plan_id: ""
    });
    setShowNewUserForm(false);
  };
  const handleNavigateToUser = (usuario: Usuario) => {
    // Only drill down if it's not a driver/monitor (which don't usually have sub-teams in this context)
    // or if they have usage > 0
    const usage = teamUsage[usuario.id];
    const hasTeam = (usage?.motoristas || 0) > 0 || (usage?.monitoras || 0) > 0 || (usage?.alunos || 0) > 0 || (usage?.indicados || 0) > 0;

    if (hasTeam || usuario.tipo_usuario === 'admin' || usuario.tipo_usuario === 'master' || usuario.tipo_usuario === 'owner') {
      navigate(`/admin/usuarios?parentId=${usuario.id}`);
    }
  };

  const navigateToBreadcrumb = (index: number) => {
    const item = breadcrumbs[index];
    if (item.id === 'filter') return; // Clicar no label do filtro n√£o faz nada

    const newBreadcrumbs = breadcrumbs.slice(0, index + 1);
    setBreadcrumbs(newBreadcrumbs);

    // Atualizar URL (isso disparar√° o useEffect)
    if (item.id) {
      navigate(`/admin/usuarios?parentId=${item.id}`, { replace: true });
    } else {
      navigate('/admin/usuarios', { replace: true });
    }
  };

  async function handleCleanupDuplicates() {
    if (!confirm("Isso ir√° remover registros duplicados de 'Maxwell' e 'Enclaro', mantendo apenas uma vers√£o de cada (por CPF ou Email). Deseja continuar?")) return;
    try {
      setLoading(true);
      const { data, error } = await supabase.functions.invoke('admin-users-v3', {
        method: 'POST',
        body: { action: 'cleanup-specific-duplicates' }
      });
      if (error) throw error;
      toast({
        title: "Limpeza conclu√≠da",
        description: `${data.deleted?.length || 0} duplicados removidos.`,
      });
      loadUsuarios();
    } catch (err: any) {
      toast({
        title: "Erro na limpeza",
        description: err.message,
        variant: "destructive"
      });
    } finally {
      setLoading(false);
    }
  }

  const handleCreateUser = async () => {
    setSaving(true);
    try {
      const validation = newUserSchema.parse(newUserData);

      const { data, error } = await supabase.functions.invoke('admin-users-v3', {
        method: 'POST',
        body: {
          nome: validation.nome,
          email: validation.email,
          password: validation.password,
          telefone: newUserData.telefone,
          cpf: newUserData.cpf,
          tipo_usuario: newUserData.tipo_usuario,
          van_id: newUserData.van_id || null,
          salario: newUserData.salario_base || 0,
          app: 'rotafacil',
          endereco: {
            cep: newUserData.cep,
            rua: newUserData.rua,
            numero: newUserData.numero,
            bairro: newUserData.bairro,
            cidade: newUserData.cidade,
            estado: newUserData.estado,
            complemento: newUserData.complemento
          }
        },
      });
      if (error) throw error;

      toast({ title: 'Sucesso', description: 'Usu√°rio criado com sucesso!' });
      resetNewUserForm();
      await loadUsuarios();
    } catch (error: any) {
      console.error('Erro ao criar usu√°rio:', error);
      if (error instanceof z.ZodError) {
        toast({ title: 'Erro de valida√ß√£o', description: error.errors[0].message, variant: 'destructive' });
      } else {
        toast({ title: 'Erro', description: error?.message || 'N√£o foi poss√≠vel criar o usu√°rio.', variant: 'destructive' });
      }
    } finally {
      setSaving(false);
    }
  };

  const getStatusColor = (status: string) => {
    switch (status) {
      case "ativo": return "bg-gold/10 text-gold border-gold/20";
      case "inativo": return "bg-red-500/10 text-red-500 border-red-500/20";
      case "pendente": return "bg-black-primary/50 text-muted-foreground border-sidebar-border";
      default: return "bg-black-primary/50 text-muted-foreground border-sidebar-border";
    }
  };

  const getTipoColor = (tipo: string) => {
    switch (tipo) {
      case "admin": return "bg-gold text-black-primary font-bold";
      case "consultor": return "bg-gold/20 text-gold border-gold/30";
      case "owner": return "bg-primary text-black font-bold";
      case "motorista": return "bg-black-secondary text-gold border-gold/40";
      case "monitora": return "bg-black-secondary text-gold border-gold/40";
      case "usuario": return "bg-black-primary text-muted-foreground border-sidebar-border opacity-60";
      default: return "bg-black-primary text-muted-foreground border-sidebar-border opacity-60";
    }
  };

  const filteredUsuarios = (usuarios || []).filter(u => {
    // Filtro por busca
    const searchLower = searchTerm.toLowerCase();

    // Alias para busca amig√°vel
    let term = searchLower;
    if (term === 'dono' || term === 'proprietario') term = 'owner';
    if (term === 'mestre') term = 'master';

    const matchName = (u.nome || "").toLowerCase().includes(searchLower);
    const matchEmail = (u.email || "").toLowerCase().includes(searchLower);
    const matchPhone = (u.telefone || u.user_metadata?.phone || "").includes(searchTerm);
    const matchType = (u.tipo_usuario || "").toLowerCase().includes(term);

    return matchName || matchEmail || matchPhone || matchType;
  });

  if (loading) {
    return (
      <AdminLayout>
        <div className="flex items-center justify-center min-h-[50vh]">
          <p className="text-muted-foreground">Carregando usu√°rios...</p>
        </div>
      </AdminLayout>
    );
  }

  return (
    <AdminLayout>
      <div className="space-y-6">
        <div className="flex items-center gap-4">
          <Button
            variant="ghost"
            size="icon"
            onClick={() => {
              if (breadcrumbs.length > 1) {
                navigateToBreadcrumb(breadcrumbs.length - 2);
              } else {
                navigate(-1);
              }
            }}
            className="w-10 h-10 rounded-full bg-gold hover:bg-gold/80 text-black shadow-lg shadow-gold/20"
          >
            <ArrowLeft className="w-6 h-6" />
          </Button>
          <div className="flex flex-col">
            <h1 className="text-2xl font-black text-gold uppercase tracking-tighter">Gerenciar Usu√°rios</h1>
            <p className="text-muted-foreground text-xs uppercase tracking-widest font-bold">Controle de Rede e Colaboradores</p>
          </div>
        </div>

        <div className="flex flex-col md:flex-row items-start md:items-center justify-between gap-4">
          <div className="flex-1 w-full relative">
            <Search className="absolute left-3 top-1/2 -translate-y-1/2 w-5 h-5 text-muted-foreground" />
            <Input
              placeholder="Buscar por nome ou email..."
              value={searchTerm}
              onChange={(e) => setSearchTerm(e.target.value)}
              className="pl-10 h-12 bg-card border-border/50 focus:border-primary transition-all text-lg"
            />
          </div>
          <div className="flex items-center bg-muted/50 p-1 rounded-xl border border-border/50">
            <Button
              variant={filterMode === 'rotafacil' ? "default" : "ghost"}
              size="sm"
              onClick={() => setFilterMode('rotafacil')}
              className="h-10 px-4 rounded-lg font-bold text-xs uppercase flex items-center gap-2"
            >
              Rota F√°cil
              {userCounts.rotafacil > 0 && (
                <span className="bg-black/20 px-1.5 py-0.5 rounded text-[10px]">{userCounts.rotafacil}</span>
              )}
            </Button>
            <Button
              variant={filterMode === 'all' ? "default" : "ghost"}
              size="sm"
              onClick={() => setFilterMode('all')}
              className="h-10 px-4 rounded-lg font-bold text-xs uppercase flex items-center gap-2"
            >
              Aguardando Kit
              {userCounts.total > 0 && (
                <span className="bg-amber-500 text-black px-1.5 py-0.5 rounded text-[10px] min-w-[1.2rem] text-center">
                  {userCounts.total}
                </span>
              )}
            </Button>
          </div>
          <div className="flex gap-2 w-full md:w-auto">
            <Button
              variant="outline"
              size="sm"
              className="flex items-center gap-2"
              onClick={() => loadUsuarios()}
              disabled={loading}
            >
              <RefreshCw className={`w-4 h-4 ${loading ? "animate-spin" : ""}`} />
              Recarregar
            </Button>
            <Button
              onClick={() => setShowNewUserForm(true)}
              className="h-12 px-6 text-base font-semibold"
            >
              <UserPlus className="w-5 h-5 mr-2" />
              Cadastrar Novo Usu√°rio
            </Button>
          </div>
        </div>

        {duplicates.length > 0 && (
          <div className="bg-amber-500/10 border border-amber-500/50 p-4 rounded-xl flex flex-col md:flex-row items-center justify-between gap-4 animate-in fade-in slide-in-from-top-4 duration-500">
            <div className="flex items-center gap-3 text-amber-500">
              <AlertTriangle className="w-8 h-8" />
              <div>
                <p className="font-bold text-lg">Duplicatas Detectadas (Maxwell / Enclaro)</p>
                <p className="text-xs opacity-80">
                  {duplicates.length} registro(s) repetidos encontrados. Recomendamos a limpeza para evitar erros de login.
                </p>
              </div>
            </div>
            <div className="flex gap-2 w-full md:w-auto">
              <Button
                variant="outline"
                size="sm"
                className="flex-1 md:flex-none border-amber-500/50 text-amber-500 hover:bg-amber-500/20"
                onClick={() => {
                  toast({
                    title: "Dica de Limpeza",
                    description: "As duplicatas foram listadas no console (F12) para sua confer√™ncia.",
                  });
                  console.table(duplicates);
                }}
              >
                Ver Detalhes
              </Button>
              <Button
                size="sm"
                className="flex-1 md:flex-none bg-amber-500 text-black hover:bg-amber-600 font-bold"
                onClick={handleCleanupDuplicates}
              >
                Limpar Duplicatas
              </Button>
            </div>
          </div>
        )}

        {/* Breadcrumbs */}
        <nav className="flex items-center gap-2 text-sm text-muted-foreground bg-muted/30 p-3 rounded-lg border border-border/50">
          {breadcrumbs.map((bc, index) => (
            <div key={bc.id || 'root'} className="flex items-center gap-2">
              <button
                onClick={() => navigateToBreadcrumb(index)}
                className={`hover:text-primary transition-colors flex items-center gap-1 ${index === breadcrumbs.length - 1 ? "text-primary font-bold pointer-events-none" : ""}`}
              >
                {index === 0 && <Home className="w-4 h-4" />}
                {bc.nome}
              </button>
              {index < breadcrumbs.length - 1 && <ChevronRight className="w-4 h-4" />}
            </div>
          ))}
        </nav>

        {/* Formul√°rio de Novo Usu√°rio */}
        {showNewUserForm && (
          <Card className="border-border bg-card">
            <CardHeader>
              <CardTitle className="flex items-center gap-2">
                <UserPlus className="w-5 h-5" />
                Cadastrar Novo Usu√°rio
              </CardTitle>
            </CardHeader>
            <CardContent className="space-y-6 p-6">
              <div className="grid grid-cols-1 md:grid-cols-2 gap-6">
                <div className="space-y-2">
                  <Label htmlFor="new-nome" className="text-base font-semibold text-foreground">
                    Nome Completo *
                  </Label>
                  <Input
                    id="new-nome"
                    value={newUserData.nome}
                    onChange={(e) => setNewUserData(prev => ({ ...prev, nome: e.target.value }))}
                    placeholder="Digite o nome completo"
                    className="h-12 text-base bg-background border-2 border-border focus:border-primary"
                  />
                </div>

                <div className="space-y-2">
                  <Label htmlFor="new-email" className="text-base font-semibold text-foreground">
                    Email *
                  </Label>
                  <Input
                    id="new-email"
                    type="email"
                    value={newUserData.email}
                    onChange={(e) => setNewUserData(prev => ({ ...prev, email: e.target.value }))}
                    placeholder="email@exemplo.com"
                    className="h-12 text-base bg-background border-2 border-border focus:border-primary"
                  />
                </div>
              </div>

              <div className="grid grid-cols-1 md:grid-cols-2 gap-6">
                <div className="space-y-2">
                  <Label htmlFor="new-password" className="text-base font-semibold text-foreground">
                    Senha *
                  </Label>
                  <Input
                    id="new-password"
                    type="password"
                    value={newUserData.password}
                    onChange={(e) => setNewUserData(prev => ({ ...prev, password: e.target.value }))}
                    placeholder="Digite a senha"
                    className="h-12 text-base bg-background border-2 border-border focus:border-primary"
                  />
                  <p className="text-sm text-muted-foreground">M√≠nimo 6 caracteres</p>
                </div>

                <div className="space-y-2">
                  <Label htmlFor="new-confirm-password" className="text-base font-semibold text-foreground">
                    Confirmar Senha *
                  </Label>
                  <Input
                    id="new-confirm-password"
                    type="password"
                    value={newUserData.confirmPassword}
                    onChange={(e) => setNewUserData(prev => ({ ...prev, confirmPassword: e.target.value }))}
                    placeholder="Confirme a senha"
                    className="h-12 text-base bg-background border-2 border-border focus:border-primary"
                  />
                </div>
              </div>

              <div className="grid grid-cols-1 md:grid-cols-3 gap-6">
                <div className="space-y-2">
                  <Label htmlFor="new-telefone" className="text-base font-semibold text-foreground">
                    Telefone
                  </Label>
                  <Input
                    id="new-telefone"
                    value={newUserData.telefone}
                    onChange={(e) => setNewUserData(prev => ({ ...prev, telefone: e.target.value }))}
                    placeholder="(11) 99999-9999"
                    className="h-12 text-base bg-background border-2 border-border focus:border-primary"
                  />
                </div>

                <div className="space-y-2">
                  <Label htmlFor="new-status" className="text-base font-semibold text-foreground">
                    Status do Usu√°rio
                  </Label>
                  <Select value={newUserData.status} onValueChange={(value) => setNewUserData(prev => ({ ...prev, status: value }))}>
                    <SelectTrigger className="h-12 text-base bg-background border-2 border-border focus:border-primary">
                      <SelectValue placeholder="Selecione o status" />
                    </SelectTrigger>
                    <SelectContent className="bg-popover border-border z-50">
                      <SelectItem value="ativo" className="text-base">‚úÖ Ativo</SelectItem>
                      <SelectItem value="inativo" className="text-base">‚ùå Inativo</SelectItem>
                      <SelectItem value="pendente" className="text-base">‚è≥ Pendente</SelectItem>
                    </SelectContent>
                  </Select>
                </div>

                <div className="grid grid-cols-1 md:grid-cols-2 gap-6">
                  <div className="space-y-2">
                    <Label htmlFor="new-cpf" className="text-base font-semibold text-foreground">
                      CPF
                    </Label>
                    <Input
                      id="new-cpf"
                      value={newUserData.cpf}
                      onChange={(e) => setNewUserData(prev => ({ ...prev, cpf: e.target.value }))}
                      placeholder="000.000.000-00"
                      className="h-12 text-base bg-background border-2 border-border focus:border-primary"
                    />
                  </div>
                  <div className="space-y-2">
                    <Label htmlFor="new-cep" className="text-base font-semibold text-foreground">
                      CEP
                    </Label>
                    <Input
                      id="new-cep"
                      value={newUserData.cep}
                      onChange={(e) => setNewUserData(prev => ({ ...prev, cep: e.target.value }))}
                      placeholder="00000-000"
                      className="h-12 text-base bg-background border-2 border-border focus:border-primary"
                    />
                  </div>
                </div>

                <div className="grid grid-cols-1 md:grid-cols-2 gap-6">
                  <div className="space-y-2">
                    <Label htmlFor="new-rua" className="text-base font-semibold text-foreground">
                      Rua
                    </Label>
                    <Input
                      id="new-rua"
                      value={newUserData.rua}
                      onChange={(e) => setNewUserData(prev => ({ ...prev, rua: e.target.value }))}
                      className="h-12 text-base bg-background border-2 border-border focus:border-primary"
                    />
                  </div>
                  <div className="space-y-2">
                    <Label htmlFor="new-numero" className="text-base font-semibold text-foreground">
                      N√∫mero
                    </Label>
                    <Input
                      id="new-numero"
                      value={newUserData.numero}
                      onChange={(e) => setNewUserData(prev => ({ ...prev, numero: e.target.value }))}
                      className="h-12 text-base bg-background border-2 border-border focus:border-primary"
                    />
                  </div>
                </div>
              </div>

              <div className="grid grid-cols-1 md:grid-cols-3 gap-6">
                <div className="space-y-2">
                  <Label htmlFor="new-bairro" className="text-base font-semibold text-foreground">
                    Bairro
                  </Label>
                  <Input
                    id="new-bairro"
                    value={newUserData.bairro}
                    onChange={(e) => setNewUserData(prev => ({ ...prev, bairro: e.target.value }))}
                    className="h-12 text-base bg-background border-2 border-border focus:border-primary"
                  />
                </div>
                <div className="space-y-2">
                  <Label htmlFor="new-cidade" className="text-base font-semibold text-foreground">
                    Cidade
                  </Label>
                  <Input
                    id="new-cidade"
                    value={newUserData.cidade}
                    onChange={(e) => setNewUserData(prev => ({ ...prev, cidade: e.target.value }))}
                    className="h-12 text-base bg-background border-2 border-border focus:border-primary"
                  />
                </div>
                <div className="space-y-2">
                  <Label htmlFor="new-estado" className="text-base font-semibold text-foreground">
                    Estado (UF)
                  </Label>
                  <Input
                    id="new-estado"
                    value={newUserData.estado}
                    onChange={(e) => setNewUserData(prev => ({ ...prev, estado: e.target.value.toUpperCase() }))}
                    maxLength={2}
                    className="h-12 text-base bg-background border-2 border-border focus:border-primary"
                  />
                </div>
              </div>

              <div className="grid grid-cols-1 md:grid-cols-3 gap-6">
                <Label htmlFor="new-tipo_usuario" className="text-base font-semibold text-foreground">
                  Tipo de Usu√°rio
                </Label>
                <Select value={newUserData.tipo_usuario} onValueChange={(value) => setNewUserData(prev => ({ ...prev, tipo_usuario: value }))}>
                  <SelectTrigger className="h-12 text-base bg-background border-2 border-border focus:border-primary">
                    <SelectValue placeholder="Selecione o tipo" />
                  </SelectTrigger>
                  <SelectContent className="bg-popover border-border z-50">
                    <SelectItem value="usuario" className="text-base">üë§ Colaborador / Outros</SelectItem>
                    <SelectItem value="consultor" className="text-base">üíº Consultor de Vendas</SelectItem>
                    <SelectItem value="motorista" className="text-base">üöê Motorista (Van)</SelectItem>
                    <SelectItem value="monitora" className="text-base">üë©‚Äçüè´ Monitora (Escolar)</SelectItem>
                    <SelectItem value="admin" className="text-base">üõ°Ô∏è Administrador do Sistema</SelectItem>
                  </SelectContent>
                </Select>
              </div>

              <div className="flex gap-3 pt-4 border-t border-border">
                <Button
                  onClick={handleCreateUser}
                  disabled={saving}
                  className="h-12 px-6 text-base font-semibold"
                >
                  <UserPlus className="w-5 h-5 mr-2" />
                  {saving ? "Criando..." : "Criar Usu√°rio"}
                </Button>
                <Button
                  variant="outline"
                  onClick={resetNewUserForm}
                  className="h-12 px-6 text-base font-semibold border-2"
                >
                  <X className="w-5 h-5 mr-2" />
                  Cancelar
                </Button>
              </div>
            </CardContent>
          </Card>
        )}

        {/* Formul√°rio de Edi√ß√£o */}
        {editingUser && (
          <Card className="border-border bg-card">
            <CardHeader>
              <CardTitle className="flex items-center gap-2">
                <Edit3 className="w-5 h-5" />
                Editando Usu√°rio: <span className="font-bold">{editingUser.nome}</span>
              </CardTitle>
            </CardHeader>
            <CardContent className="space-y-6 p-6">
              <div className="grid grid-cols-1 md:grid-cols-2 gap-6">
                <div className="space-y-2">
                  <Label htmlFor="nome" className="text-base font-semibold text-foreground">
                    Nome Completo *
                  </Label>
                  <Input
                    id="nome"
                    value={formData.nome}
                    onChange={(e) => setFormData(prev => ({ ...prev, nome: e.target.value }))}
                    placeholder="Digite o nome completo"
                    className="h-12 text-base bg-background border-2 border-border focus:border-primary"
                  />
                </div>
              </div>

              <div className="grid grid-cols-1 md:grid-cols-2 gap-6">
                <div className="space-y-2">
                  <Label htmlFor="cep" className="text-base font-semibold text-foreground">
                    CEP
                  </Label>
                  <Input
                    id="cep"
                    value={formData.cep}
                    onChange={(e) => setFormData(prev => ({ ...prev, cep: e.target.value }))}
                    placeholder="00000-000"
                    className="h-12 text-base bg-background border-2 border-border focus:border-primary"
                  />
                </div>
                <div className="space-y-2">
                  <Label htmlFor="rua" className="text-base font-semibold text-foreground">
                    Rua
                  </Label>
                  <Input
                    id="rua"
                    value={formData.rua}
                    onChange={(e) => setFormData(prev => ({ ...prev, rua: e.target.value }))}
                    className="h-12 text-base bg-background border-2 border-border focus:border-primary"
                  />
                </div>
              </div>

              <div className="grid grid-cols-1 md:grid-cols-3 gap-6">
                <div className="space-y-2">
                  <Label htmlFor="numero" className="text-base font-semibold text-foreground">
                    N√∫mero
                  </Label>
                  <Input
                    id="numero"
                    value={formData.numero}
                    onChange={(e) => setFormData(prev => ({ ...prev, numero: e.target.value }))}
                    className="h-12 text-base bg-background border-2 border-border focus:border-primary"
                  />
                </div>
                <div className="space-y-2">
                  <Label htmlFor="bairro" className="text-base font-semibold text-foreground">
                    Bairro
                  </Label>
                  <Input
                    id="bairro"
                    value={formData.bairro}
                    onChange={(e) => setFormData(prev => ({ ...prev, bairro: e.target.value }))}
                    className="h-12 text-base bg-background border-2 border-border focus:border-primary"
                  />
                </div>
                <div className="space-y-2">
                  <Label htmlFor="cidade" className="text-base font-semibold text-foreground">
                    Cidade
                  </Label>
                  <Input
                    id="cidade"
                    value={formData.cidade}
                    onChange={(e) => setFormData(prev => ({ ...prev, cidade: e.target.value }))}
                    className="h-12 text-base bg-background border-2 border-border focus:border-primary"
                  />
                </div>
                <div className="space-y-2">
                  <Label htmlFor="estado" className="text-base font-semibold text-foreground">
                    Estado (UF)
                  </Label>
                  <Input
                    id="estado"
                    value={formData.estado}
                    onChange={(e) => setFormData(prev => ({ ...prev, estado: e.target.value.toUpperCase() }))}
                    maxLength={2}
                    className="h-12 text-base bg-background border-2 border-border focus:border-primary"
                  />
                </div>
              </div>

              <div className="space-y-2">
                <Label htmlFor="complemento" className="text-base font-semibold text-foreground">
                  Complemento
                </Label>
                <Input
                  id="complemento"
                  value={formData.complemento}
                  onChange={(e) => setFormData(prev => ({ ...prev, complemento: e.target.value }))}
                  className="h-12 text-base bg-background border-2 border-border focus:border-primary"
                />
              </div>

              <div className="space-y-2">
                <Label htmlFor="email" className="text-base font-semibold text-foreground">
                  Email *
                </Label>
                <Input
                  id="email"
                  type="email"
                  value={formData.email}
                  onChange={(e) => setFormData(prev => ({ ...prev, email: e.target.value }))}
                  placeholder="email@exemplo.com"
                  className="h-12 text-base bg-background border-2 border-border focus:border-primary"
                />
              </div>

              <div className="grid grid-cols-1 md:grid-cols-2 gap-6">
                <div className="space-y-2">
                  <Label htmlFor="cpf" className="text-base font-semibold text-foreground">
                    CPF
                  </Label>
                  <Input
                    id="cpf"
                    value={formData.cpf}
                    onChange={(e) => setFormData(prev => ({ ...prev, cpf: e.target.value }))}
                    placeholder="000.000.000-00"
                    className="h-12 text-base bg-background border-2 border-border focus:border-primary"
                  />
                </div>

                <div className="grid grid-cols-1 md:grid-cols-3 gap-6">
                  <div className="space-y-2">
                    <Label htmlFor="telefone" className="text-base font-semibold text-foreground">
                      Telefone
                    </Label>
                    <Input
                      id="telefone"
                      value={formData.telefone}
                      onChange={(e) => setFormData(prev => ({ ...prev, telefone: e.target.value }))}
                      placeholder="(11) 99999-9999"
                      className="h-12 text-base bg-background border-2 border-border focus:border-primary"
                    />
                  </div>

                  <div className="space-y-2">
                    <Label htmlFor="tipo_usuario" className="text-base font-semibold text-foreground">
                      Tipo de Usu√°rio
                    </Label>
                    <Select value={formData.tipo_usuario} onValueChange={(value) => setFormData(prev => ({ ...prev, tipo_usuario: value }))}>
                      <SelectTrigger className="h-12 text-base bg-background border-2 border-border focus:border-primary">
                        <SelectValue placeholder="Selecione o tipo" />
                      </SelectTrigger>
                      <SelectContent className="bg-popover border-border z-50">
                        <SelectItem value="usuario" className="text-base">üë§ Colaborador / Outros</SelectItem>
                        <SelectItem value="consultor" className="text-base">üíº Consultor de Vendas</SelectItem>
                        <SelectItem value="motorista" className="text-base">üöê Motorista (Van)</SelectItem>
                        <SelectItem value="monitora" className="text-base">üë©‚Äçüè´ Monitora (Escolar)</SelectItem>
                        <SelectItem value="admin" className="text-base">üõ°Ô∏è Administrador do Sistema</SelectItem>
                        <SelectItem value="master" className="text-base">üëë RS Oficial (Dono)</SelectItem>
                        <SelectItem value="owner" className="text-base">üè¢ Empresa / Propriet√°rio</SelectItem>
                      </SelectContent>
                    </Select>
                  </div>

                  <div className="space-y-4">
                    <div className="space-y-2">
                      <Label className="text-base font-semibold text-foreground">Kit / Plano do Sistema</Label>
                      <Select
                        value={formData.plan_id}
                        onValueChange={(value) => setFormData(prev => ({ ...prev, plan_id: value }))}
                      >
                        <SelectTrigger className="h-12 text-base bg-background border-2 border-border focus:border-primary">
                          <SelectValue placeholder="Selecione o Plano (Kit)" />
                        </SelectTrigger>
                        <SelectContent className="bg-popover border-border z-50">
                          {plans.map(p => (
                            <SelectItem key={p.id} value={p.id} className="text-base">{p.name}</SelectItem>
                          ))}
                        </SelectContent>
                      </Select>
                      <p className="text-sm text-muted-foreground">
                        Alterar o Kit atualizar√° imediatamente o limite de alunos e frotas do usu√°rio.
                      </p>
                    </div>

                    <div className="space-y-2">
                      <Label className="text-base font-semibold text-foreground">Status do Usu√°rio</Label>
                      <Select
                        value={formData.status}
                        onValueChange={(value) => setFormData(prev => ({ ...prev, status: value }))}
                      >
                        <SelectTrigger className="h-12 text-base bg-background border-2 border-border focus:border-primary">
                          <SelectValue placeholder="Status" />
                        </SelectTrigger>
                        <SelectContent className="bg-popover border-border z-50">
                          <SelectItem value="ativo" className="text-base">‚úÖ Ativo</SelectItem>
                          <SelectItem value="inativo" className="text-base">‚ùå Inativo</SelectItem>
                          <SelectItem value="pendente" className="text-base">‚è≥ Pendente</SelectItem>
                        </SelectContent>
                      </Select>
                    </div>
                  </div>

                  {(formData.tipo_usuario === 'motorista' || formData.tipo_usuario === 'monitora') && (
                    <div className="md:col-span-3 border-t border-border/50 pt-6 mt-4 grid grid-cols-1 md:grid-cols-2 gap-6 bg-gold/5 p-6 rounded-xl border border-gold/10">
                      <div className="space-y-4">
                        <h4 className="text-gold font-black uppercase tracking-widest text-xs flex items-center gap-2">
                          <CreditCard className="w-4 h-4" />
                          Ajustes Financeiros (Equipe)
                        </h4>
                        <div className="space-y-2">
                          <Label htmlFor="salario_base" className="text-sm font-bold">Sal√°rio Base (R$)</Label>
                          <Input
                            id="salario_base"
                            type="number"
                            value={formData.salario_base}
                            onChange={(e) => setFormData(prev => ({ ...prev, salario_base: parseFloat(e.target.value) }))}
                            className="h-11 border-gold/20 focus:border-gold"
                          />
                        </div>
                      </div>
                      <div className="flex flex-col justify-end">
                        <Button
                          onClick={() => handleRegisterPayment(editingUser.id)}
                          className="h-12 bg-green-600 hover:bg-green-700 text-white font-bold uppercase tracking-widest text-xs"
                        >
                          <Plus className="w-4 h-4 mr-2" />
                          Registrar Novo Pagamento
                        </Button>
                        <p className="text-[10px] text-muted-foreground mt-2 italic">
                          Isso adicionar√° uma nova entrada no hist√≥rico financeiro do colaborador.
                        </p>
                      </div>
                    </div>
                  )}
                </div>
              </div>

              <div className="flex justify-between items-center pt-6 border-t border-border/50">
                <div className="flex gap-3">
                  <Button onClick={handleSave} disabled={saving} className="h-12 px-6 text-base font-semibold bg-primary hover:bg-primary/90 gap-2">
                    {saving ? <Loader2 className="w-5 h-5 animate-spin" /> : <Save className="w-5 h-5" />}
                    {saving ? "Salvando..." : "Salvar Altera√ß√µes"}
                  </Button>
                  <Button variant="outline" onClick={resetForm} disabled={saving} className="h-12 px-6 text-base font-semibold border-2 gap-2">
                    <X className="w-5 h-5" />
                    Cancelar
                  </Button>
                </div>

                <Button
                  variant="outline"
                  onClick={() => setShowPasswordForm(editingUser.id)}
                  className="h-12 px-6 text-base font-semibold border-primary/20 hover:bg-primary/5 text-primary gap-2"
                >
                  <Key className="w-5 h-5" />
                  Alterar Senha
                </Button>
              </div>
            </CardContent>
          </Card>
        )}

        {/* Formul√°rio de Altera√ß√£o de Senha */}
        {
          showPasswordForm && (
            <Card className="border-border bg-card">
              <CardHeader>
                <CardTitle className="flex items-center gap-2">
                  <Key className="w-5 h-5" />
                  Alterar Senha do Usu√°rio
                </CardTitle>
              </CardHeader>
              <CardContent className="space-y-6 p-6">
                <div className="grid grid-cols-1 md:grid-cols-2 gap-6">
                  <div className="space-y-2">
                    <Label htmlFor="newPassword" className="text-base font-semibold text-foreground">
                      Nova Senha *
                    </Label>
                    <Input
                      id="newPassword"
                      type="password"
                      value={passwordData.newPassword}
                      onChange={(e) => setPasswordData(prev => ({ ...prev, newPassword: e.target.value }))}
                      placeholder="Digite a nova senha"
                      className="h-12 text-base bg-background border-2 border-border focus:border-primary"
                    />
                    <p className="text-sm text-muted-foreground">M√≠nimo 6 caracteres</p>
                  </div>

                  <div className="space-y-2">
                    <Label htmlFor="confirmPassword" className="text-base font-semibold text-foreground">
                      Confirmar Nova Senha *
                    </Label>
                    <Input
                      id="confirmPassword"
                      type="password"
                      value={passwordData.confirmPassword}
                      onChange={(e) => setPasswordData(prev => ({ ...prev, confirmPassword: e.target.value }))}
                      placeholder="Confirme a nova senha"
                      className="h-12 text-base bg-background border-2 border-border focus:border-primary"
                    />
                    <p className="text-sm text-muted-foreground">Deve ser igual √† senha acima</p>
                  </div>
                </div>

                <div className="flex gap-3 pt-4 border-t border-border">
                  <Button
                    onClick={() => handleChangePassword(showPasswordForm)}
                    disabled={changingPassword}
                    className="h-12 px-6 text-base font-semibold bg-orange-500 hover:bg-orange-600 gap-2"
                  >
                    {changingPassword ? <Loader2 className="w-5 h-5 animate-spin" /> : <Key className="w-5 h-5" />}
                    {changingPassword ? "Alterando..." : "Confirmar Altera√ß√£o"}
                  </Button>
                  <Button
                    variant="outline"
                    onClick={() => {
                      setShowPasswordForm(null);
                      setPasswordData({ newPassword: "", confirmPassword: "" });
                    }}
                    className="h-12 px-6 text-base font-semibold border-2"
                  >
                    <X className="w-5 h-5 mr-2" />
                    Cancelar
                  </Button>
                </div>
              </CardContent>
            </Card>
          )
        }

        {/* Lista de Usu√°rios */}
        <div className="grid gap-4">
          {filteredUsuarios.map((usuario) => (
            <Card key={usuario.id} className="border-border/50 bg-card hover:border-primary/30 transition-all group relative overflow-hidden">
              <div className="absolute top-0 left-0 w-1 h-full bg-primary opacity-0 group-hover:opacity-100 transition-opacity" />
              <CardContent className="p-6">
                <div className="flex items-center justify-between">
                  <div className="flex items-center gap-4">
                    <div
                      className="w-12 h-12 bg-gradient-primary rounded-full flex items-center justify-center cursor-pointer hover:scale-105 transition-transform"
                      onClick={() => handleNavigateToUser(usuario)}
                    >
                      {(usuario.tipo_usuario === 'admin' || usuario.tipo_usuario === 'master' || usuario.tipo_usuario === 'owner') ? (
                        <Folder className="w-6 h-6 text-white" />
                      ) : (
                        <User className="w-6 h-6 text-white" />
                      )}
                    </div>

                    <div>
                      <div className="flex items-center gap-2">
                        <h3 className="font-bold text-lg">{usuario.nome}</h3>
                        {(() => {
                          const isMasterOrOwner = usuario.tipo_usuario === 'master' || usuario.tipo_usuario === 'owner';
                          const hasTeam = (teamUsage[usuario.id]?.motoristas || 0) > 0 ||
                            (teamUsage[usuario.id]?.monitoras || 0) > 0 ||
                            (teamUsage[usuario.id]?.alunos || 0) > 0 ||
                            (teamUsage[usuario.id]?.indicados || 0) > 0;
                          const isOfficial = usuario.nome?.toLowerCase().includes('rota f√°cil') ||
                            usuario.nome?.toLowerCase().includes('rota facil');
                          const hasActivePlan = usuario.plan_id || hasTeam || isOfficial;

                          return (
                            <Badge variant="outline" className={`capitalize ${usuario.tipo_usuario === 'admin' ? "bg-red-500/10 text-red-500 border-red-500/20" :
                              isMasterOrOwner
                                ? (hasActivePlan ? "bg-primary/10 text-primary border-primary/20" : "bg-amber-500/10 text-amber-500 border-amber-500/20 shadow-[0_0_10px_rgba(245,158,11,0.2)]")
                                : "bg-muted text-muted-foreground"
                              }`}>
                              {usuario.tipo_usuario === 'admin' ? 'Administrador do Sistema' :
                                isMasterOrOwner
                                  ? (hasActivePlan ? 'Empresa / Propriet√°rio' : 'Aguardando Kit ‚è≥')
                                  : (usuario.tipo_usuario || 'Usu√°rio')}
                            </Badge>
                          );
                        })()}
                      </div>
                      <div className="flex items-center gap-4 text-sm text-muted-foreground">
                        <div className="flex items-center gap-1">
                          <Mail className="w-4 h-4" />
                          {usuario.email}
                        </div>
                        {usuario.telefone && (
                          <div className="flex items-center gap-1">
                            <Phone className="w-4 h-4" />
                            {usuario.telefone}
                          </div>
                        )}
                        {usuario.cpf && (
                          <div className="flex items-center gap-1 font-bold text-primary">
                            <Shield className="w-4 h-4" />
                            {usuario.cpf}
                          </div>
                        )}
                      </div>

                      <div className="flex flex-wrap items-center gap-x-4 gap-y-2 mt-4">
                        <div className="flex items-center gap-3 text-[10px] bg-muted/40 px-3 py-1.5 rounded-lg border border-border/30">
                          <span className="font-black text-foreground/50 uppercase tracking-tighter mr-1">Equipe:</span>

                          <div
                            className="flex items-center gap-1.5 cursor-pointer hover:text-primary transition-colors group/item"
                            onClick={() => navigate(`/admin/usuarios?parentId=${usuario.id}&filterType=motorista`)}
                          >
                            <Bus className="w-3 h-3 text-primary/70 group-hover/item:scale-110 transition-transform" />
                            <span className="font-bold">{usuario.motoristas || 0}</span>
                            <span className="opacity-70">Motoristas</span>
                          </div>

                          <div
                            className="flex items-center gap-1.5 cursor-pointer hover:text-primary transition-colors group/item"
                            onClick={() => navigate(`/admin/usuarios?parentId=${usuario.id}&filterType=monitora`)}
                          >
                            <UserCheck className="w-3 h-3 text-primary/70 group-hover/item:scale-110 transition-transform" />
                            <span className="font-bold">{usuario.monitoras || 0}</span>
                            <span className="opacity-70">Monitoras</span>
                          </div>

                          <div
                            className="flex items-center gap-1.5 cursor-pointer hover:text-primary transition-colors group/item"
                            onClick={() => navigate(`/admin/usuarios?parentId=${usuario.id}&filterType=indicado`)}
                          >
                            <Target className="w-3 h-3 text-primary/70 group-hover/item:scale-110 transition-transform" />
                            <span className="font-bold">{usuario.indicados || 0}</span>
                            <span className="opacity-70">Indicados</span>
                          </div>

                          <div
                            className="flex items-center gap-1.5 cursor-pointer hover:text-primary transition-colors group/item"
                            onClick={() => navigate(`/admin/usuarios?parentId=${usuario.id}&filterType=aluno`)}
                          >
                            <Users className="w-3 h-3 text-primary/70 group-hover/item:scale-110 transition-transform" />
                            <span className="font-bold">{usuario.alunos || 0}</span>
                            <span className="opacity-70">Alunos</span>
                          </div>
                        </div>

                        {((usuario.motoristas || 0) > 0 || (usuario.alunos || 0) > 0) && (
                          <Badge variant="outline" className="text-[10px] border-primary/30 text-primary/80 bg-primary/5 px-2 py-0.5 font-bold tracking-tight uppercase">
                            Conta Master / Empresa
                          </Badge>
                        )}
                      </div>
                    </div>
                  </div>

                  <div className="flex items-center gap-2">
                    {((teamUsage[usuario.id]?.motoristas || 0) > 0 || (teamUsage[usuario.id]?.alunos || 0) > 0 || (teamUsage[usuario.id]?.indicados || 0) > 0 ||
                      usuario.tipo_usuario === 'master' || usuario.tipo_usuario === 'owner' || usuario.tipo_usuario === 'admin') && (
                        <Button
                          size="sm"
                          variant="ghost"
                          className="text-primary hover:text-primary-foreground hover:bg-primary transition-all font-semibold border border-primary/20"
                          onClick={() => handleNavigateToUser(usuario)}
                        >
                          <Folder className="w-4 h-4 mr-2" />
                          Ver Equipe
                          <ChevronRight className="w-4 h-4 ml-1" />
                        </Button>
                      )}
                    {(usuario.tipo_usuario === 'motorista' || usuario.tipo_usuario === 'monitora') && (
                      <Button
                        size="sm"
                        variant="secondary"
                        className="bg-yellow-400 hover:bg-yellow-500 text-black font-semibold"
                        onClick={() => navigate(`/admin/usuarios/${usuario.id}/visualizar`, { state: { type: usuario.tipo_usuario } })}
                      >
                        <User className="w-4 h-4 mr-2" />
                        Ver Painel
                      </Button>
                    )}
                    <Button size="sm" variant="outline" onClick={() => handleEdit(usuario)}>
                      <Edit3 className="w-4 h-4 mr-2" />
                      Editar
                    </Button>
                    <Button
                      size="sm"
                      variant="outline"
                      className="text-amber-600 border-amber-200/50 hover:bg-amber-50 dark:hover:bg-amber-900/10 font-bold gap-2 transition-all active:scale-95 shadow-sm"
                      onClick={() => handleResendConfirmationForUser(usuario.email)}
                    >
                      <RefreshCw className="w-4 h-4" />
                      Reenviar E-mail
                    </Button>
                  </div>
                </div>

                <div className="flex items-center justify-between mt-4 pt-4 border-t text-xs text-muted-foreground">
                  <span>Cadastrado: {new Date(usuario.created_at).toLocaleString('pt-BR')}</span>
                  {usuario.ultimo_login && (
                    <span>√öltimo login: {new Date(usuario.ultimo_login).toLocaleString('pt-BR')}</span>
                  )}
                </div>
              </CardContent>
            </Card>
          ))}
        </div>

        {error && (
          <Card className="border-destructive/50 bg-destructive/5 mb-6">
            <CardContent className="p-6 text-center">
              <div className="w-12 h-12 bg-destructive/10 rounded-full flex items-center justify-center mx-auto mb-4">
                <AlertCircle className="w-6 h-6 text-destructive" />
              </div>
              <h3 className="text-lg font-bold text-destructive mb-2">Erro ao carregar dados</h3>
              <p className="text-muted-foreground mb-6 max-w-md mx-auto">
                {error}
              </p>
              <Button onClick={() => loadUsuarios()} variant="default" className="gap-2">
                <RefreshCw className="w-4 h-4" />
                Tentar Novamente
              </Button>
            </CardContent>
          </Card>
        )}

        {
          usuarios.length === 0 && !loading && !error && (
            <Card>
              <CardContent className="p-12 text-center">
                <div className="w-20 h-20 bg-muted/50 rounded-full flex items-center justify-center mx-auto mb-6">
                  <Users className="w-10 h-10 text-muted-foreground" />
                </div>
                <h3 className="text-xl font-bold mb-2">Nenhum usu√°rio nesta pasta</h3>
                <p className="text-muted-foreground mb-6 max-w-sm mx-auto">
                  {currentParentId
                    ? "Esta equipe ainda n√£o possui colaboradores cadastrados."
                    : "Nenhuma conta Master ou Admin encontrada no n√≠vel geral."}
                </p>
                <Button onClick={() => loadUsuarios()} variant="outline" className="gap-2">
                  <RefreshCw className="w-4 h-4" />
                  Recarregar Lista
                </Button>
              </CardContent>
            </Card>
          )
        }
      </div >
    </AdminLayout >
  );
}