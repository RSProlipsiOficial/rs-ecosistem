<!DOCTYPE html>
<html lang="pt-BR">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Fix Vans RLS - RotaF√°cil</title>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            max-width: 900px;
            margin: 50px auto;
            padding: 20px;
            background: #1a1a1a;
            color: #fff;
        }

        h1 {
            color: #ffd700;
        }

        .warning {
            background: #ff6b00;
            color: #fff;
            padding: 15px;
            border-radius: 8px;
            margin: 20px 0;
        }

        button {
            background: #ffd700;
            color: #000;
            border: none;
            padding: 15px 30px;
            font-size: 16px;
            font-weight: bold;
            cursor: pointer;
            border-radius: 8px;
            margin: 10px 5px;
        }

        button:hover {
            background: #ffed4e;
        }

        button:disabled {
            background: #666;
            cursor: not-allowed;
        }

        #log {
            background: #000;
            padding: 20px;
            border-radius: 8px;
            font-family: 'Courier New', monospace;
            font-size: 14px;
            max-height: 500px;
            overflow-y: auto;
            margin-top: 20px;
        }

        .success {
            color: #0f0;
        }

        .error {
            color: #f00;
        }

        .info {
            color: #0ff;
        }
    </style>
</head>

<body>
    <h1>üîß Corre√ß√£o SIMPLES de Pol√≠ticas RLS - Vans</h1>

    <div class="warning">
        <strong>‚ö†Ô∏è O QUE ACONTECEU:</strong><br>
        - Suas vans e dados N√ÉO SUMIRAM<br>
        - O problema √© s√≥ nas pol√≠ticas RLS (permiss√µes de acesso)<br>
        - Esta corre√ß√£o vai SIMPLIFICAR as pol√≠ticas para funcionar<br>
        - Leva menos de 10 segundos
    </div>

    <button id="fixBtn" onclick="fixVansRLS()">‚úÖ CORRIGIR RLS VANS</button>
    <button id="rpcBtn" onclick="updateRPC()">üì± ATUALIZAR CONTATOS WHATSAPP</button>
    <button onclick="testVans()">üß™ Testar Vans</button>
    <button onclick="location.reload()">üîÑ Recarregar P√°gina</button>

    <div id="log"></div>

    <script type="module">
        import { createClient } from 'https://esm.sh/@supabase/supabase-js@2'

        const supabaseUrl = 'https://rptkhrboejbwexseikuo.supabase.co'
        const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InJwdGtocmJvZWpid2V4c2Vpa3VvIiwicm9sZSI6ImFub24iLCJpYXQiOjE3MzQ5NzUxMDgsImV4cCI6MjA1MDU1MTEwOH0.xdVQFnMJWEbPBvZNSYzLjPqtjUhKQlqJBGKsqPXNTpY'

        window.supabase = createClient(supabaseUrl, supabaseKey)

        function log(message, type = 'info') {
            const logDiv = document.getElementById('log')
            const className = type === 'success' ? 'success' : type === 'error' ? 'error' : 'info'
            logDiv.innerHTML += `<div class="${className}">${message}</div>`
            logDiv.scrollTop = logDiv.scrollHeight
        }

        window.updateRPC = async function () {
            const btn = document.getElementById('rpcBtn')
            btn.disabled = true
            log('üì± Iniciando atualiza√ß√£o da fun√ß√£o SQL de contatos...', 'info')

            const sql = `
                CREATE OR REPLACE FUNCTION public.get_van_contacts(p_van_id UUID)
                RETURNS JSONB
                LANGUAGE plpgsql
                SECURITY DEFINER
                AS $$
                DECLARE
                    v_owner_id UUID;
                    v_owner_name TEXT;
                    v_owner_phone TEXT;
                    v_contacts JSONB := '[]'::JSONB;
                    v_record RECORD;
                BEGIN
                    SELECT user_id INTO v_owner_id FROM public.vans WHERE id = p_van_id;
                    
                    SELECT 
                        COALESCE(up.nome_completo, (u.raw_user_meta_data->>'nome_completo'), (u.raw_user_meta_data->>'name'), 'Dono da Empresa'),
                        COALESCE(up.telefone, (u.raw_user_meta_data->>'telefone'), (u.raw_user_meta_data->>'phone'), '')
                    INTO v_owner_name, v_owner_phone
                    FROM auth.users u
                    LEFT JOIN public.user_profiles up ON up.user_id = u.id
                    WHERE u.id = v_owner_id;

                    v_contacts := v_contacts || jsonb_build_object(
                        'role', 'dono',
                        'name', v_owner_name,
                        'phone', v_owner_phone
                    );

                    FOR v_record IN (
                        SELECT 
                            u.id,
                            COALESCE(up.nome_completo, (u.raw_user_meta_data->>'nome_completo'), (u.raw_user_meta_data->>'name'), 'Colaborador') as nome,
                            COALESCE(up.telefone, (u.raw_user_meta_data->>'telefone'), (u.raw_user_meta_data->>'phone'), '') as telefone,
                            LOWER(COALESCE(u.raw_user_meta_data->>'tipo_usuario', u.raw_user_meta_data->>'user_type', '')) as tipo
                        FROM auth.users u
                        LEFT JOIN public.user_profiles up ON up.user_id = u.id
                        WHERE (
                            (u.raw_user_meta_data->>'van_id')::UUID = p_van_id
                            OR 
                            ((u.raw_user_meta_data->>'boss_id')::UUID = v_owner_id AND (u.raw_user_meta_data->>'tipo_usuario' IN ('motorista', 'monitora')))
                        )
                        AND u.deleted_at IS NULL
                    ) LOOP
                        v_contacts := v_contacts || jsonb_build_object(
                            'role', v_record.tipo,
                            'name', v_record.nome,
                            'phone', v_record.telefone
                        );
                    END LOOP;

                    RETURN v_contacts;
                END;
                $$;

                GRANT EXECUTE ON FUNCTION public.get_van_contacts(UUID) TO authenticated;
                GRANT EXECUTE ON FUNCTION public.get_van_contacts(UUID) TO anon;
                GRANT EXECUTE ON FUNCTION public.get_van_contacts(UUID) TO service_role;
            `

            try {
                const { error } = await window.supabase.rpc('exec_sql', { sql: sql })
                if (error) {
                    log(`‚ùå Erro ao atualizar RPC: ${error.message}`, 'error')
                    log('Por favor, verifique se a fun√ß√£o "exec_sql" est√° habilitada no seu Supabase.', 'info')
                } else {
                    log('‚úÖ Fun√ß√£o de contatos atualizada com sucesso!', 'success')
                }
            } catch (err) {
                log(`‚ùå Exce√ß√£o: ${err.message}`, 'error')
            }
            btn.disabled = false
        }

        window.fixVansRLS = async function () {
            const btn = document.getElementById('fixBtn')
            btn.disabled = true
            document.getElementById('log').innerHTML = ''

            log('üîß Removendo pol√≠ticas antigas...', 'info')

            // Lista de TODAS as pol√≠ticas antigas para remover
            const dropPolicies = [
                "Vans: dynamic_visibility",
                "Guardian can view their students van",
                "Usu√°rios podem atualizar suas pr√≥prias vans",
                "Usu√°rios podem deletar suas pr√≥prias vans",
                "Usu√°rios podem inserir suas pr√≥prias vans",
                "Users can view their own vans",
                "Users can insert their own vans",
                "Users can update their own vans",
                "Users can delete their own vans",
                "Guardians view student vans",
                "vans_select_own",
                "vans_insert_own",
                "vans_update_own",
                "vans_delete_own",
                "vans_select_guardian"
            ]

            for (const policyName of dropPolicies) {
                const query = `DROP POLICY IF EXISTS "${policyName}" ON vans`
                try {
                    await window.supabase.rpc('exec_sql', { sql: query })
                    log(`‚úÖ Removida: ${policyName}`, 'success')
                } catch (err) {
                    log(`‚ö†Ô∏è ${policyName} n√£o existia`, 'info')
                }
            }

            log('\nüîß Criando pol√≠ticas SIMPLES...', 'info')

            // Criar apenas 2 pol√≠ticas SIMPLES que funcionam
            const newPolicies = [
                {
                    name: 'vans_owner_all',
                    sql: `CREATE POLICY "vans_owner_all" ON vans FOR ALL TO authenticated USING (user_id = auth.uid()) WITH CHECK (user_id = auth.uid())`
                },
                {
                    name: 'vans_public_read',
                    sql: `CREATE POLICY "vans_public_read" ON vans FOR SELECT TO authenticated USING (true)`
                }
            ]

            for (const policy of newPolicies) {
                try {
                    const { error } = await window.supabase.rpc('exec_sql', { sql: policy.sql })
                    if (error) {
                        log(`‚ùå Erro ao criar ${policy.name}: ${error.message}`, 'error')
                    } else {
                        log(`‚úÖ Criada: ${policy.name}`, 'success')
                    }
                } catch (err) {
                    log(`‚ùå Exce√ß√£o: ${err.message}`, 'error')
                }
            }

            log('\n‚úÖ CORRE√á√ÉO CONCLU√çDA!', 'success')
            log('üëâ Clique em "Testar Vans" para verificar', 'info')
            btn.disabled = false
        }

        window.testVans = async function () {
            log('\nüß™ Testando acesso √†s vans...', 'info')

            const { data, error } = await window.supabase
                .from('vans')
                .select('id, nome, user_id')
                .limit(10)

            if (error) {
                log(`‚ùå ERRO: ${error.message}`, 'error')
                log('‚ö†Ô∏è Se o erro persistir, entre em contato com suporte', 'error')
            } else {
                log(`‚úÖ SUCESSO! ${data.length} vans encontradas:`, 'success')
                if (data.length === 0) {
                    log('‚ö†Ô∏è Nenhuma van cadastrada ainda', 'info')
                } else {
                    data.forEach(v => log(`   üì¶ ${v.nome} (ID: ${v.id.substring(0, 8)}...)`, 'success'))
                    log('\nüéâ TUDO FUNCIONANDO! Pode voltar para o sistema', 'success')
                }
            }
        }
    </script>
</body>

</html>